# 네트워크 계층
## 데이터 링크 계층의 한계

1. 물리 계층과 데이터 링크 계층만으로 다른 네트워크까지의 도달 경로를 파악하기 어렵다.
물리와 데이터 링크 계층은 기본적으로 LAN을 다루는 계층이다
하지만 LAN에 속한 호스트끼리만 통신하지는 않는다
지구 반대편에 있는 사용자가 정보를 주고 받는다면, 해당 패킷은 서로에게 도달하기까지 수많은 네트워크 장비를 거친다
이때 최적의 경로로 빠르게 패킷의 이동 경로를 결정하는 것을 '라우팅'(routing)이라한다.

라우팅을 수행하는 네트워크 장비로는 '라우터'가 있다.

2. MAC 주소만으로는 모든 네트워크에 속한 호스트의 위치를 특정하기 어렵다.
네트워크에서도 MAC주소와 IP주소를 함께 사용하고, 기본적으로 IP 주소를 우선적으로 활용하는데
MAC 주소를 물리 주소라고도 부르고, IP 주소는 논리 주소라고도 부른다.

일반적으로 MAC 주소는 NIC 마다 할당되는 고정 주소이지만, IP 주소는 호스트에 직접 할당이 가능하며
DHCP(Dynamic Host Configuration Protocol) 라는 특정 프로토콜을 통해 자동으로 할당받거나 사용자가 직접 할당할 수도 있다.

또한 한 호스트가 복수의 IP 주소를 가질수도있다.

> 💡 물리계층과 데이터 링크 계층만으로 네트워크 간의 통신이 어렵고, 네트워크 계층이 다른 네트워크와 통신을 가능케 한다, 이는 IP 주소를 이용해 수신지 주소를 설정하거나, 해당 수신지까지의 최적의 경로를 결정하는 라우팅이 네트워크 계층에서 이루어지 때문이다.

## 인터넷 프로토콜, Internet Protocol
IP는 두 가지의 버전이 있는데 IPv4와 IPv6이다.

### IP 주소 형태
IP주소는 4바이트(32bit)로 주소를 표현할 수 있고, 숫자당 8비트로 표현되기에 0~255 범위안에 있는 네 개의 10진수로 표기된다.
각 10진수는 "."으로 구분되며 점으로 구분된 8비트를 옥텟(octet)이라 한다.

```
192, 168, 1,1
```
각각은 8비트로 표현된 옥텟이다.

### IP 기능

IP 주소 기능, IP addressing
IP 주소를 바탕으로 송수신 대상을 지정하는 것을 의미하며,
IP 단편화(IP fragmentation)는 전송하고자 하는 패킷의 크기가
MTU라는 최대 전송 단위보다 클 경우, 이를 MTU 크기 이하의 복수의 패킷으로 나누는것을 의미한다.

```
💡 MTU, Maximum Transmission Unit 란 한번에 전송 가능한 IP 패킷의 최대 크기를 의미한다
IP 패킷의 헤더도 MTU 크기에 포함되며 일반적으로 MTU 크기는 1500 바이트이며, MTU 크기 이하로 나누어진 패킷은 수신지에 도착해 재조합된다.

```

## IPv4
![IPv4payload](http://ktword.co.kr/img_data/1859_1.jpg)

1. 식별자, identifier
식별자는 패킷에 할당된 번호이다.
만일 메시지 전송 과정에서 IPv4 패킷이 여러 조각으로 쪼개져서 전송되었다면, 수신지에서는 이것을 재조합해야한다.

이때 잘게 쪼개져 수신지에 도착한 IPv4 패킷들이 어떤 메시지에서부터 쪼개졌는지 인식하기 위해 식별자를 사용한다.


2. 플래그, flag
총 세 개의 비트로 구성된 필드이다.
이 중에서 첫 번째 비트는 항상 0으로 예약된 비트로 현재 사용되지는 않는다.

사용되는 나머지 두 개의 비트 중에서 하나의 DF 라는 이름이 붙은 비트이며, Don't Fragment의 약어로, IP 단편화를 수행하지 말라는 표시이다.
만일 이 비트가 1 로 설정되어 있다면 IP 단편화를 수행하지 않고, 0으로 설정되었다면 IP 단편화가 가능하다.

마지막 비트는 MF 이며, More Fragment의 약어이며 단편화된 패킷이 더 있는지 나타낸다.
만약 0이면 이 패킷이 마지막이라는 것을 의미하고 1이라면 쪼개진 패킷이 아직 더 있다는 걸 의미한다

3. 단편화 오프셋, fragment offset
패킷이 단편화되기 전에 패킷의 초기 데이터에서 몇 번째로 떨어진 패킷인지를 나타낸다.
단편화되어 전송되는 패킷들은 수신지에 순서대로 도착하지 않을 수 있다.
따라서 수신지가 패킷들을 순서대로 재조합하려면 단편화된 패킷이 초기 데이터에서 몇 번째 데이터에 해당하는 패킷인지 알아야하는데,
이를 판단하기 위해 단편화 오프셋을 활용한다.

4. TTL, Time To Live
패킷의 수명을 나타내며 멀리 떨어진 호스트끼리 통신할 때 패킷은 여러 라우터를 거쳐 이동할 수도 있는데,
패킷이 하나의 라우터를 거칠때 마다 TTL이1 씩 감소하며 TTL이 값이 0으로 떨어진 패킷은 폐기한다.

```
💡 패킷이 호스트 또는 라우터에 한번 전달되는 것을 홉(hop) 이라 하고, TTL 필드의 값은 홉마다 1씩 감소한다
이는 TTL 필드의 존재 이유가 무의미한 패킷이 네트워크 상에서 지속적으로 남아있는 것을 방지하기 위함
```

5. 프로토콜, protocol
IP 패킷의 프로토콜은 상위 계층의 프로토콜이 무엇인지를 나타내는 필드이다.
ex) TCP는 6번, UDP는 17번

6. 송신지IP주소, Source IP address

7. 수신지IP주, Destination IP address


## IPv6
IPv4는 총 2^32개로 약 43억개
전 셰계 인구가 하나씩 IP 주소를 가진다면 모자를 숫자인데 하물며 IP 주소를 가질수 있는 장치가 스마트폰, 데스크톰, 노트북 등 여러 개이기에 IPv4 총량이 턱없이 부족하다는 점이다.

IPv6 16바이트(128bit)로 주소를 표현할 수 있고, 콜론(:)으로 구분된 8개 그룹과 16진수로 표기된다.
IPv6는 2^128개로 사실상 무한에 가까운 개수를 할당할 수 있기에, IPv4를 보완하고자 등장한게 IPv6이다.

```
IPv4
192.168.1.1


IPv6
2001:0230:abcd:ffff:0000:0000:ffff:llll
```

![IPv6payload](https://media.geeksforgeeks.org/wp-content/uploads/ipv6-header.png)

1. 다음 헤더, next header
다음 헤더 필드는 상위 계층의 프로토콜을 가리키거나 확장 헤더를 가르킨다.

![nextHeader](https://notes.shichao.io/tcpv1/figure_5-6.png)

확장 헤더의 종류는 다양하기에 상황에 맞는 다양한 정보를 운반할 수 있다.
- 송수신지에 이르는 모든 경로의 네트워크 장비가 패킷을 검사하도록 하는 홉간 옵션 Hop-by-Hop-Option
- 수신지에서만 패킷을 검사하도록 하는 수신지 옵션 Destination Options
- 라우팅 관련 정보를 운반하는 라우팅 Routing,
- 단편화를 위한 단편 Fragment
- 암호화 인증을 위한 ESP(Encapsulating Security Payload)
- AH(Authentication Header)확장 헤더


2. 홉 제한, hop limit
홉 제한 필드는 IPv4 packet의 TTL 필드와 비슷하게 패킷의 수명을 나타내는 필드

3. 송신지IP주소

4. 수신지IP주소

IPv6는 주소 지정이 가능하다
IPv4 헤더 길이는 가변적이지만 IPv6는 기본 헤더는 40바이트로 고정이다


